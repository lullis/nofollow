---
- hosts: all
  gather_facts: false
  become: true

  vars:
    - cindy_app_development_mode: true
    - cindy_database_username: vagrant
    - cindy_database_password: insecurepasswd_database
    - cindy_app_static_root_path: /home/vagrant/cindy_web/static
    - cindy_app_email_backend: django.core.mail.backends.console.EmailBackend
    - cindy_app_log_folder_path: /home/vagrant/cindy_web/logs
    - cindy_app_secret_key: this_is_an_insecure_secret_key
    - cindy_app_username: vagrant
    - cindy_app_code_folder_path: /home/vagrant/code/src
    - cindy_app_pypi_url: file:///home/vagrant/code/src
    - cindy_message_queue_user_name: cindy
    - cindy_message_queue_user_password: insecurepasswd_rabbitmq
    - cindy_message_queue_vhost: /cindy

    - rabbitmq_enabled: yes
    - rabbitmq_plugins:
        - rabbitmq_management
    - rabbitmq_users:
        - user: admin
          password: admin
          vhost: /
          configure_priv: .*
          read_priv: .*
          write_priv: .*
          tags: administrator
        - user: "{{ cindy_message_queue_user_name }}"
          password: "{{ cindy_message_queue_user_password }}"
          vhost: "{{ cindy_message_queue_vhost }}"
    - rabbitmq_vhosts: ["{{ cindy_message_queue_vhost }}"]

  roles:
    - role: stouts.rabbitmq
    - role: ANXS.postgresql
    - role: cindy_common_environment
    - role: cindy_database

  pre_tasks:
  - include: setup.yml

  - name: add some lines to .bashrc
    lineinfile:
      name: /home/vagrant/.bashrc
      line: "{{ item }}"
    with_items:
      - "set -a && source {{ cindy_app_service_environment_file_path }} && set +a"
      - "source /home/vagrant/.virtualenvs/{{ cindy_app_virtualenv_name }}/bin/activate"
